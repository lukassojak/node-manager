# NODE_CONFIG_EXPLAINED.md

## Overview

`node_X_config.json` is the **unified configuration format** for a single irrigation node in the **Smart Irrigation System (SIS)**.

It replaces the legacy split configuration files:

- `config_global.json`
- `zones_config.json`

which are currently still supported by SIS, but are considered **deprecated**.

The new format:
- merges global and zone-specific configuration into **one coherent document**,
- fixes several architectural inconsistencies of the legacy design,
- introduces new features and clearer separation of concerns,
- is designed to be **server-generated** and **node-consumable**.

This document explains:
- why the new format exists,
- how it maps to the legacy configuration files,
- the structure and meaning of all fields,
- which parts are intended for **server-only**, **node runtime**, or **future extensions**.

---

## Design Goals

The unified node configuration was designed with the following goals:

1. **Single source of truth**
   - One configuration file fully describes one physical irrigation node.

2. **Deterministic, exportable artifact**
   - The file is generated by the server (via Node Manager) and can be:
     - versioned,
     - audited,
     - re-distributed,
     - re-applied without additional context.

3. **Clear runtime responsibility**
   - The node receives only what it needs to operate autonomously.
   - Server-only or system-wide configuration is excluded.


---

## Relation to Legacy Configuration Files

### `config_global.json` → Node-level sections

Legacy `config_global.json` contained **global settings implicitly shared by all zones**.

In the new format, these settings are:
- explicitly attached to a **single node**,
- grouped into logical sections:
  - `irrigation_limits`
  - `automation`
  - `batch_strategy`
  - `logging`
  - `hardware`

---

### `zones_config.json` → `zones[]`

Legacy `zones_config.json` defined zones as a flat list, loosely coupled to the node.

In the new format:
- zones are **embedded directly in the node configuration**,
- each zone is fully self-contained,
- multiple irrigation modes are supported in a consistent way.

---

## File Structure (High-Level)

```text
node_X_config.json
├── metadata
├── node identity
├── hardware
├── irrigation_limits
├── automation
├── batch_strategy
├── logging
└── zones[]
    ├── zone identity
    ├── relay_pin
    ├── enabled
    ├── irrigation_mode
    ├── zone specific correction factors
    ├── frequency settings
    ├── fallback behavior
    ├── mode specific configuration
    └── emitters[]
```

Each section is explained in detail below.

---

## Detailed Field Explanations

### `metadata` section

```json
"metadata": {
  "version": "0.12.0",
  "last_updated": "2025-12-12T12:00:00",
  "exported_at": "2025-12-12T12:00:00"
}
```

**Fields:**
- `version` (string): Version of the configuration schema.
- `last_updated` (ISO 8601 datetime): Timestamp of the last modification.
- `exported_at` (ISO 8601 datetime): Timestamp when this configuration was generated.

### Node Identity

```json
"node_id": "4",
"name": "Backyard Node",
"location": "Backyard Garden"
```

**Fields:**
- `node_id` (string): Unique identifier for the node. Generated by the backend.
- `name` (string): Human-readable name for the node.
- `location` (string): Description of the node's physical location.

### `hardware` section

```json
"hardware": {
  "input_pins" {
    "pins": [ ... ]
  },
  "output_pins": {
    "pins": [ ... ]
  }
}
```

**Fields:**
- `input_pins` (list of int): List of input pin numbers.
- `output_pins` (list of int): List of output pin numbers.

### `irrigation_limits` section

```json
"irrigation_limits": {
  "min_percent": 30,
  "max_percent": 200,
  "main_valve_max_flow": 850
}
```

**Fields:**
- `min_percent` (int): Lower bound of computed irrigation volume. If the calculated volume is below this percentage, irrigation volume is clamped to this value.
- `max_percent` (int): Upper bound of computed irrigation volume. If the calculated volume exceeds this percentage, irrigation volume is clamped to this value.
- `main_valve_max_flow` (int): Maximum allowed flow rate for the entire node. Represents physical water supply limits. `null` means no limit.

### `automation` section

```json
"automation": {
        "enabled": true,
        "scheduled_hour": 6,
        "scheduled_minute": 30,
        "environment": "production",
        "weather_cache_interval_minutes": 30,
        "weather_cache_expiry_hours": 2
    }
```

**Purpose:** Controls automatic irrigation scheduling and runtime behavior.

**Fields:**
- `enabled` (bool): Enables or disables automatic irrigation for the whole node. If set to false, no zone will irrigate automatically despite their individual settings.
- `scheduled_hour` (int): Hour of the day (0-23) when daily automatic irrigation checks are performed.
- `scheduled_minute` (int): Minute of the hour (0-59) when daily automatic irrigation checks are performed.
- `environment` (string): Not used in runtime. Reserved for future use.
- `weather_cache_interval_minutes` (int): Interval in minutes for refreshing cached weather data on the node.
- `weather_cache_expiry_hours` (int): Duration in hours after which cached weather data is considered stale. After this period, new weather data will be fetched for irrigation calculations. Some strategies may still allow calculations with stale data.

### `batch_strategy` section

```json
"batch_strategy": {
        "concurrent_irrigation": true,
        "flow_control": true,
        "max_concurrent_zones": 4,
        "max_total_irrigation_time_minutes": 180
    }
```

**Purpose:** Defines how multiple zones are irrigated in batches. 

**Fields:**
- `concurrent_irrigation` (bool): If true, multiple zones can irrigate simultaneously, subject to other constraints.
- `flow_control` (bool): If true, the node will monitor and control water flow to prevent exceeding `main_valve_max_flow`.
- `max_concurrent_zones` (int): Maximum number of zones that can irrigate at the same time. `null` means no limit.
- `max_total_irrigation_time_minutes` (int): Maximum total irrigation time for all zones in a single batch. `null` means no limit.

### `logging` section

```json
"logging": {
        "enabled": true,
        "log_level": "INFO",
}
```

**Purpose:** Configures logging behavior on the node.

### `zones` array:

*Each zone represents one irrigation circuit (valve / relay).*
*Zones are fully self-contained and independent.*

```json
"zones": [ ... ]
```

### Zone - Common Fields

```json
{
    "id": 1,
    "name": "Greenhouse Bed",
    "relay_pin": 3,
    "enabled": true,
    "irrigation_mode": "even_area",
}
```

**Purpose:** Defines common properties for each irrigation zone.

**Fields:**
- `id` (int): Unique identifier for the zone within the whole system. Generated by the backend.
- `name` (string): Human-readable name for the zone.
- `relay_pin` (int): GPIO pin number controlling the zone's relay/valve.
- `enabled` (bool): Enables or disables automatic irrigation for this zone. If false, the zone will not irrigate automatically.
- `irrigation_mode` (string): Defines the irrigation mode for the zone. Possible values:
  - `even_area`: Irrigation based on area and target depth. Suitable for areas with uniform emitter distribution.
  - `per_plant`: Irrigation based on individual plant needs. Suitable for zones with diverse plants and emitter configurations, especially in pots.


### Zone - `local_correction_factors` section

```json
"local_correction_factors": {
    "solar": 1.0,
    "rain": 1.0,
    "temperature": 1.0
}
```
**Purpose:** Zone-specific correction factors applied to the base irrigation volume. Defines weather-related adjustments for the zone. They allow fine-tuning based on microclimate differences. Higher values increase the impact of the respective factor.

**Fields:**
  - `solar` (float): Correction factor for solar radiation.
  - `rain` (float): Correction factor for rainfall.
  - `temperature` (float): Correction factor for temperature.


### Zone - `frequency_settings` section

```json
"frequency_settings": {
    "dynamic_interval": true,
    "min_interval_days": 1,
    "max_interval_days": 7,
    "carry_over_volume": true,
    "irrigation_volume_threshold_percent": 20
},
```

**Purpose:** Configures how often the zone may be irrigated.

**Supports:**
- Dynamic intervals based on weather and minimum per-irrigation volume thresholds.
- Skipping insignificant irrigation cycles
- Volume accumulation over skipped irrigation cycles.
    
**Fields:**
- `dynamic_interval` (bool): If true, the node dynamically adjusts the irrigation interval between `min_interval_days` and `max_interval_days` based on weather conditions and minimum irrigation volume.
- `min_interval_days` (int): Minimum number of days between irrigation cycles. If dynamic intervals are disabled, this value is used as a fixed interval.
- `max_interval_days` (int): Maximum number of days between irrigation cycles. Only relevant if dynamic intervals are enabled.
- `carry_over_volume` (bool): If true, irrigation volume from skipped cycles (due to low volume) is accumulated and added to the next irrigation cycle. **Disabling this may lead to under-watering and is not recommended.** If dynamic intervals are disabled, this setting has no effect.
- `irrigation_volume_threshold_percent` (int): Minimum irrigation volume percentage required to perform irrigation. If the calculated volume is below this threshold, irrigation is skipped. Only relevant if dynamic intervals are enabled.

### Zone - `fallback_strategy` section

```json
"fallback_strategy": {
    "on_fresh_weather_data_unavailable": "use_cached_data",
    "on_expired_weather_data": "use_cached_data",
    "on_missing_weather_data": "use_base_volume",
},
```

**Purpose:** Defines how the zone should behave when weather data is unavailable or stale.

**Fields:**
- `on_fresh_weather_data_unavailable` (string): Strategy when fresh weather data cannot be fetched. Possible values:
  - `use_cached_data`: Use the last cached weather data.
  - `use_base_volume`: Use the base target volume without weather adjustments.
  - `use_half_base_volume`: Use half of the base target volume.
  - `skip_irrigation`: Skip irrigation for this cycle.
- `on_expired_weather_data` (string): Strategy when cached weather data is expired. Same possible values as above.
- `on_missing_weather_data` (string): Strategy when no weather data is available at all. Using cached data is not possible. Possible values:
    - `use_base_volume`: Use the base target volume without weather adjustments.
    - `use_half_base_volume`: Use half of the base target volume.
    - `skip_irrigation`: Skip irrigation for this cycle.

### Zone - Mode-Specific Configuration

```json
"irrigation_configuration": {
    "zone_area_m2": 50.0,
    "target_mm": 10.0
}
```

```json
"irrigation_configuration": {
    "base_target_volume_liters": 15.0
}
```

**Purpose:** Defines the irrigation configuration specific to the selected `irrigation_mode`. Allows to compute the base irrigation volume.

**Fields:**
- For `even_area` mode:
  - `zone_area_m2` (float): Area of the zone in square meters.
  - `target_mm` (float): Target depth of water in millimeters for the zone under base conditions.

- For `per_plant` mode:
    - `base_target_volume_liters` (float): Base target volume of water in liters for the entire zone under base conditions.

### Zone - Emitters Configuration

```json
"emitters_configuration": {
    "summary": [
        {
            "type": "dripper",
            "flow_rate_lph": 4.0,
            "quantity": 10
        },
        {
            "type": "sprinkler",
            "flow_rate_lph": 20.0,
            "quantity": 2
        },
        {
            "type": "soaker_hose",
            "flow_rate_lph": 15.0,
            "quantity": 1
        },
        {
            "type": "micro_spray",
            "flow_rate_lph": 8.0,
            "quantity": 5
        }
    ]
}
```

```json
"emitters_configuration": {
    "plants": [
        {
            "id": 1,
            "plant_name": "Tomato",
            "emitters": [
                {
                    "type": "dripper",
                    "flow_rate_lph": 4.0,
                    "count": 2
                }
            ]
        },
        {
            "id": 2,
            "plant_name": "Lettuce",
            "emitters": [
                {
                    "type": "micro_spray",
                    "flow_rate_lph": 8.0,
                    "quantity": 3
                }
            ]
        }
    ]
}
```

**Purpose:** Describes the physical emitters used in the zone to deliver water.

**Fields:**
- For `even_area` mode:
  - `summary` (list): List of emitter types used in the zone with their flow rates and quantities.
    - `type` (string): Type of emitter (e.g., dripper, sprinkler).
    - `flow_rate_lph` (float): Flow rate in liters per hour.
    - `quantity` (int): Number of emitters of this type.

- For `per_plant` mode:
    - `plants` (list): List of plants in the zone with their specific emitters.
        - `id` (int): Unique identifier for the plant within the zone.
        - `plant_name` (string): Name of the plant.
        - `emitters` (list): List of emitters assigned to this plant.
            - `type` (string): Type of emitter (e.g., dripper, micro_spray).
            - `flow_rate_lph` (float): Flow rate in liters per hour.
            - `count` (int): Number of emitters of this type assigned to the plant.

---

## Summary
The `node_X_config.json` format provides a clear, unified, and extensible way to configure irrigation nodes in the Smart Irrigation System. By consolidating global and zone-specific settings, it enhances maintainability and clarity while supporting advanced irrigation strategies.


